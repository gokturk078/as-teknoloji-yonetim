<!DOCTYPE html>
<html lang="tr" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeme Yönetim Sistemi | AS Teknolojik</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel Support -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Yükleniyor...</p>
    </div>

    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-chart-line logo-icon"></i>
                <h2>AS Finans</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="view-overview">
                    <i class="fas fa-home"></i>
                    <span>Genel Bakış</span>
                </a>
                <a href="company-panel.html" class="nav-item">
                    <i class="fas fa-building"></i>
                    <span>Şirket Borçları</span>
                </a>
                <a href="#" class="nav-item" data-view="view-records">
                    <i class="fas fa-table"></i>
                    <span>Tüm Kayıtlar</span>
                </a>
                <a href="#" class="nav-item" data-view="view-reports">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Raporlar</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=random" alt="Admin">
                    <div>
                        <p class="user-name">Yönetici</p>
                        <p class="user-role">AS Teknolojik</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="top-header">
                <div class="header-left">
                    <h1 id="pageTitle">Genel Bakış</h1>
                    <p class="text-secondary" id="pageDesc">Finansal durum özeti ve analizler</p>
                </div>

                <!-- Live Ticker -->
                <div class="currency-ticker" id="currencyTicker">
                    <div class="ticker-item">
                        <span class="currency-code">USD</span>
                        <span class="currency-value" id="rate-usd">...</span>
                    </div>
                    <div class="ticker-item">
                        <span class="currency-code">EUR</span>
                        <span class="currency-value" id="rate-eur">...</span>
                    </div>
                    <div class="ticker-item">
                        <span class="currency-code">GBP</span>
                        <span class="currency-value" id="rate-stg">...</span>
                    </div>
                </div>

                <div class="header-right">
                    <button class="btn-icon theme-toggle" title="Tema Değiştir">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    <button class="btn btn-primary" id="btnAddObject">
                        <i class="fas fa-plus"></i> <span class="d-none-mobile">Yeni Ödeme</span>
                    </button>
                </div>
            </header>

            <!-- VIEW: OVERVIEW -->
            <div id="view-overview" class="view-section active">
                <!-- Overview Stats -->
                <section class="stats-grid">
                    <div class="stat-card">
                        <div class="icon-box bg-blue-light text-blue">
                            <i class="fas fa-list"></i>
                        </div>
                        <div>
                            <p class="stat-label">Toplam Kayıt</p>
                            <h3 class="stat-value" id="totalRecords">0</h3>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon-box bg-green-light text-green">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="stat-label">Toplam Ödenen</p>
                            <h3 class="stat-value" id="totalPaid">₺0</h3>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon-box bg-red-light text-red" style="background: #fef2f2; color: #ef4444;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div>
                            <p class="stat-label">Toplam Borç</p>
                            <h3 class="stat-value" id="totalDebt">₺0</h3>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="icon-box bg-orange-light text-orange" style="background: #fffbeb; color: #f59e0b;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div>
                            <p class="stat-label">Kalan</p>
                            <h3 class="stat-value" id="totalRemaining">₺0</h3>
                        </div>
                    </div>
                </section>

                <!-- Charts Section -->
                <section class="charts-section">
                    <div class="chart-card">
                        <h3>Ödeme Trendi</h3>
                        <div class="chart-container">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Ödeme Durumu</h3>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                    </div>
                </section>
                <!-- Data Table Section (Moved to Overview) -->
                <section class="table-card" id="tableSection">
                    <div class="card-header">
                        <div class="header-title-group">
                            <h3>Tüm Ödeme Kayıtları</h3>
                            <div class="excel-actions">
                                <button class="btn-sm btn-outline" id="btnExportExcel" title="Excel İndir">
                                    <i class="fas fa-file-excel text-green"></i> İndir
                                </button>
                                <label for="excelInput" class="btn-sm btn-outline cursor-pointer" title="Excel Yükle">
                                    <i class="fas fa-upload text-blue"></i> Yükle
                                    <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none">
                                </label>
                            </div>
                        </div>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchInput" placeholder="Firma, Kalem veya İş Ara...">
                            <button class="btn-icon" id="btnOpenFilters" title="Gelişmiş Filtre"
                                style="margin-left: 0.5rem; border:none; background: transparent;">
                                <i class="fas fa-filter text-primary"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Drag & Drop Zone (Hidden by default, shown on drag) -->
                    <div id="dropZone" class="drop-zone hidden">
                        <div class="drop-content">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                            <h3>Excel Dosyasını Buraya Bırakın</h3>
                            <p>Orijinal "FERİT ABİ TABLO.xlsx" formatı desteklenir</p>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <th class="checkbox-cell" width="40"><input type="checkbox" id="checkboxAll"></th>
                                <th>S.No</th>
                                <th>Ödeme Kalemi</th>
                                <th>Firma</th>
                                <th>İşin Nevi</th>
                                <th>Fatura</th>
                                <th>İş Adı</th>
                                <th>Para</th>
                                <th>Önceki</th>
                                <th>Bu Ayki</th>
                                <th>Toplam</th>
                                <th>Ödenen</th>
                                <th>Kalan</th>
                                <th>Durum</th>
                                <th>Döküman</th>
                                <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- Data populated by JS -->
                            </tbody>
                            <th>Belge</th>
                            <th>İşlem</th>
                            </tr>
                            </thead>
                            <tbody id="tableBody">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                        <div id="emptyState" class="empty-state" style="display:none">
                            <i class="fas fa-inbox"></i>
                            <p>Kayıt bulunamadı</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- VIEW: REPORTS -->
            <div id="view-reports" class="view-section" style="display: none;">
                <!-- Report Control Bar -->
                <div class="report-controls">
                    <div class="control-group">
                        <label><i class="far fa-calendar-alt"></i> Dönem:</label>
                        <select id="reportPeriod" class="form-select-sm">
                            <option value="all">Tüm Zamanlar</option>
                            <option value="this_month">Bu Ay</option>
                            <option value="last_month">Geçen Ay</option>
                            <option value="ytd">Bu Yıl (YTD)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label><i class="fas fa-coins"></i> Rapor Kuru:</label>
                        <select id="reportCurrency" class="form-select-sm">
                            <option value="TL">Türk Lirası (₺)</option>
                            <option value="USD">Amerikan Doları ($)</option>
                            <option value="EUR">Euro (€)</option>
                            <option value="STG">Sterlin (£)</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="window.print()">
                        <i class="fas fa-print"></i> PDF / Yazdır
                    </button>
                </div>

                <!-- Report Title (Visible mostly in Print) -->
                <div class="report-header-print">
                    <h1>AS Teknolojik - Finansal Rapor</h1>
                    <p id="reportDateRange">...</p>
                </div>

                <!-- KPI Cards -->
                <section class="stats-grid report-kpis">
                    <div class="stat-card">
                        <p class="stat-label">Toplam Borç Stoğu</p>
                        <h3 class="stat-value text-danger" id="kpiTotalDebt">₺0</h3>
                        <small class="trend-down">Ödenmemiş Kalemler</small>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">Bu Ay Ödenen</p>
                        <h3 class="stat-value text-success" id="kpiMonthlyPaid">₺0</h3>
                        <small class="trend-up">Nakit Çıkışı</small>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">Proje Başına Ort. Maliyet</p>
                        <h3 class="stat-value" id="kpiAvgCost">₺0</h3>
                    </div>
                </section>

                <div class="report-grid">
                    <!-- Cash Flow / Debt Waterfall -->
                    <div class="chart-card large">
                        <h3>Nakit Akışı ve Borç Dağılımı</h3>
                        <div class="chart-container">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>

                    <!-- Side Analytics -->
                    <div class="analytics-col">
                        <!-- Currency Risk -->
                        <div class="chart-card">
                            <h3>Döviz Riski Dağılımı</h3>
                            <div class="chart-container-sm">
                                <canvas id="currencyRiskChart"></canvas>
                            </div>
                        </div>

                        <!-- Top Projects Table -->
                        <div class="chart-card">
                            <h3>En Maliyetli Projeler (Top 5)</h3>
                            <table class="mini-table">
                                <thead>
                                    <tr>
                                        <th>Proje</th>
                                        <th class="text-right">Tutar</th>
                                    </tr>
                                </thead>
                                <tbody id="topProjectsBody">
                                    <!-- JS Generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </main>
    </div>

    <!-- Modals -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Yeni Ödeme Kaydı</h3>
                <button class="modal-close">&times;</button>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="paymentId" name="id">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Sıra No *</label>
                        <input type="number" id="siraNo" name="sira_no" required>
                    </div>

                    <div class="form-group">
                        <label>Fatura Durumu *</label>
                        <select id="faturaDurumu" name="fatura_durumu" required>
                            <option value="">Seçiniz</option>
                            <option value="FATURALI">FATURALI</option>
                            <option value="FATURASIZ">FATURASIZ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Ödeme Kalemi *</label>
                        <input type="text" id="odemeKalemleri" name="odeme_kalemleri" required
                            placeholder="Örn: SGK Ödemesi">
                    </div>

                    <div class="form-group">
                        <label>Firma Fatura İsmi</label>
                        <input type="text" id="firmaFaturaIsmi" name="firma_fatura_ismi" placeholder="Firma tam ünvanı">
                    </div>

                    <div class="form-group">
                        <label>Firma IBAN</label>
                        <input type="text" id="firmaIbanlari" name="firma_ibanlari" placeholder="TR...">
                    </div>

                    <div class="form-group">
                        <label>İşin Nevi</label>
                        <select id="isinNevi" name="isin_nevi">
                            <option value="">Seçiniz</option>
                            <option value="RESMİ KURUM HARÇLARI">RESMİ KURUM HARÇLARI</option>
                            <option value="NAKLİYE">NAKLİYE</option>
                            <option value="TAŞERON">TAŞERON</option>
                            <option value="MALZEME TEDARİĞİ">MALZEME TEDARİĞİ</option>
                            <option value="DEMİR BAŞ">DEMİR BAŞ</option>
                            <option value="MAKİNE EKİPMAN">MAKİNE EKİPMAN</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>İş Adı / Proje</label>
                        <input type="text" id="isinAdi" name="isin_adi" placeholder="Örn: GZ Otel">
                    </div>

                    <div class="form-group">
                        <label>Para Birimi *</label>
                        <select id="paraBirimi" name="para_birimi" required>
                            <option value="TL">TL</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="STG">STG</option>
                        </select>
                    </div>

                    <div class="separator"
                        style="grid-column: span 2; border-bottom: 1px solid var(--border-color); margin: 0.5rem 0;">
                    </div>

                    <div class="form-group">
                        <label>Önceki Dönem Borç</label>
                        <input type="number" step="0.01" id="oncekiBorc" name="onceki_donemden_kalan_borc" value="0">
                    </div>

                    <div class="form-group">
                        <label>Bu Ayki Borç</label>
                        <input type="number" step="0.01" id="buAykiBorc" name="bu_ayki_borc" value="0">
                    </div>

                    <div class="form-group">
                        <label>Toplam Borç</label>
                        <input type="number" step="0.01" id="toplamBorc" name="toplam_borc" value="0" readonly
                            style="background: var(--bg-hover);">
                    </div>

                    <div class="form-group">
                        <label>Bu Ay Ödenen</label>
                        <input type="number" step="0.01" id="buAyOdenen" name="bu_ay_odenen" value="0">
                    </div>

                    <div class="form-group">
                        <label>Kalan Tutar</label>
                        <input type="number" step="0.01" id="kalan" name="kalan" value="0" readonly
                            style="background: var(--bg-hover);">
                    </div>

                    <div class="form-group">
                        <label>Ödeme Durumu *</label>
                        <select id="odemeDurumu" name="odeme_durumu" required>
                            <option value="ÖDENMEDİ">ÖDENMEDİ</option>
                            <option value="KISMEN ÖDENDİ">KISMEN ÖDENDİ</option>
                            <option value="ÖDENDİ">ÖDENDİ</option>
                            <option value="BEKLEMEDE">BEKLEMEDE</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label>Belge Yükle (PDF/Görsel)</label>
                        <input type="file" id="documentUpload" accept=".pdf,.png,.jpg,.jpeg">
                        <input type="hidden" id="ekrakYuklemeUrl" name="ekrak_yukleme_url">
                        <div id="filePreview" class="text-sm mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary modal-close">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <div class="toast-icon"><i class="fas fa-check"></i></div>
        <div class="toast-body">
            <strong id="toastTitle">Başlık</strong>
            <p id="toastMessage">Mesaj</p>
        </div>
    </div>

    <!-- Advanced Filter Drawer -->
    <div class="drawer-backdrop" id="backdropFilters"></div>
    <aside class="filter-drawer" id="filterDrawer">
        <div class="drawer-header">
            <h3>Gelişmiş Filtreleme</h3>
            <button class="btn-close-drawer" id="btnCloseFilters"><i class="fas fa-times"></i></button>
        </div>
        <div class="drawer-content">
            <!-- Filter: Company -->
            <div class="filter-section">
                <h4>Firmalar</h4>
                <div class="checkbox-group" id="filterCompany">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Filter: Project -->
            <div class="filter-section">
                <h4>Projeler</h4>
                <div class="checkbox-group" id="filterProject">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Filter: Currency -->
            <div class="filter-section">
                <h4>Para Birimi</h4>
                <div class="checkbox-group" id="filterCurrency">
                    <label class="checkbox-item"><input type="checkbox" value="TL"> <span>TL (Türk
                            Lirası)</span></label>
                    <label class="checkbox-item"><input type="checkbox" value="USD"> <span>USD (Dolar)</span></label>
                    <label class="checkbox-item"><input type="checkbox" value="EUR"> <span>EUR (Euro)</span></label>
                    <label class="checkbox-item"><input type="checkbox" value="STG"> <span>STG (Sterlin)</span></label>
                </div>
            </div>

            <!-- Filter: Status -->
            <div class="filter-section">
                <h4>Ödeme Durumu</h4>
                <div class="checkbox-group" id="filterStatus">
                    <label class="checkbox-item"><input type="checkbox" value="ÖDENMEDİ"> <span>Ödenmedi</span></label>
                    <label class="checkbox-item"><input type="checkbox" value="KISMEN ÖDENDİ"> <span>Kısmen
                            Ödendi</span></label>
                    <label class="checkbox-item"><input type="checkbox" value="BEKLEMEDE">
                        <span>Beklemede</span></label>
                    <label class="checkbox-item"><input type="checkbox" value="ÖDENDİ"> <span>Ödendi
                            (Tamamlanan)</span></label>
                </div>
            </div>

            <!-- Filter: Amount -->
            <div class="filter-section">
                <h4>Borç Tutarı (TL Değeri)</h4>
                <div class="range-inputs">
                    <input type="number" id="filterMinAmount" placeholder="Min">
                    <span>-</span>
                    <input type="number" id="filterMaxAmount" placeholder="Max">
                </div>
            </div>
        </div>
        <div class="drawer-footer">
            <button class="btn btn-secondary" id="btnResetFilters">Reset</button>
            <button class="btn btn-primary" id="btnApplyFilters">Uygula</button>
        </div>
    </aside>

    <!-- Floating Action Bar (Bulk Actions) -->
    <div class="floating-action-bar" id="floatingActionBar">
        <div class="fab-content">
            <span class="selected-count" id="selectedCount">0 Kayıt Seçildi</span>
            <div class="fab-actions">
                <button class="btn-fab btn-fab-delete" id="btnBulkDelete">
                    <i class="fas fa-trash"></i> Sil
                </button>
                <div class="fab-divider"></div>
                <button class="btn-fab" id="btnBulkEdit"><i class="fas fa-pen"></i> Toplu Düzenle</button>
                <div class="fab-divider"></div>
                <button class="btn-fab" data-status="ÖDENDİ">Ödendi</button>
                <button class="btn-fab" data-status="BEKLEMEDE">Beklemede</button>
            </div>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div class="modal" id="bulkEditModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Toplu Düzenleme</h3>
                <button class="modal-close" data-target="bulkEditModal"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Güncellenecek Alan</label>
                    <select id="bulkFieldSelect" class="form-select">
                        <option value="firma_fatura_ismi">Firma İsmi</option>
                        <option value="isin_adi">İş Adı / Proje</option>
                        <option value="isin_nevi">İşin Nevi</option>
                        <option value="odeme_kalemleri">Ödeme Kalemi</option>
                        <option value="para_birimi">Para Birimi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Yeni Değer</label>
                    <input type="text" id="bulkValueInput" class="form-input" placeholder="Yeni değeri girin...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close" data-target="bulkEditModal">İptal</button>
                <button class="btn btn-primary" id="btnConfirmBulkEdit">Güncelle</button>
            </div>
        </div>
    </div>

    <script src="supabase-init.js?v=fixed"></script>
    <script type="module" src="src/main.js?v=fixed"></script>
</body>

</html>